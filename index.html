<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ•™å¸ˆèŠ‚ä¸“å±ç¥ç¦</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html-to-image"></script>
  <meta name="description" content="è¾“å…¥åå­—å³å¯ç”Ÿæˆä¸“å±æ•™å¸ˆèŠ‚è´ºå¡ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ã€‚" />
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.7);backdrop-filter:saturate(1.2) blur(8px)}
    .container-max{max-width:88rem}
    .action-bar{position:sticky;bottom:0;left:0;right:0}
    /* â€”â€” ä¿¡å°è§†è§‰ â€”â€” */
    .env-3d{perspective:1200px}
    .envelope{width:min(92vw,520px);height:300px;background:#fff6ed;border:1px solid #f1ddd0;border-radius:20px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    .envelope .flap{position:absolute;left:50%;top:0;transform:translateX(-50%);width:0;height:0;border-left:260px solid transparent;border-right:260px solid transparent;border-top:160px solid #f6d9bf;transform-origin:50% 0;transition:transform .6s cubic-bezier(.2,.8,.2,1)}
    .envelope.open .flap{transform:translateX(-50%) rotateX(180deg)}
    .stamp{position:absolute;right:18px;top:18px;background:#dbeafe;border:1px dashed #93c5fd;border-radius:6px;padding:6px 8px;font-size:12px;color:#1e3a8a;transform:rotate(8deg)}
    .postmark{position:absolute;left:18px;bottom:18px;color:#fb923c;font-size:12px;opacity:.8}
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
  <header id="header" class="px-4 py-6 md:px-8">
    <h1 class="text-2xl md:text-3xl font-bold tracking-tight flex items-center gap-2">
      <span>ğŸ“ æ•™å¸ˆèŠ‚ç¥ç¦</span>
      <span class="text-xs md:text-sm font-normal text-zinc-500">è¾“å…¥åå­— â†’ æ‰“å¼€ä¿¡å° â†’ ç”Ÿæˆè´ºå¡</span>
    </h1>
  </header>

  <main id="layout" class="mx-auto container-max px-4 md:px-8 pb-24 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- å·¦ï¼šç¼–è¾‘åŒºï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
    <section id="leftPanel" class="md:col-span-1 space-y-4">
      <div id="teacherBlock" class="glass rounded-2xl border p-4 shadow-sm">
        <label class="block text-sm font-semibold mb-1">è€å¸ˆç§°å‘¼æˆ–åå­—</label>
        <input id="teacherInput" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400" placeholder="å¦‚ï¼šç‹è€å¸ˆ / ç‹å°æ˜" />
      </div>

      <div id="fromBlock" class="glass rounded-2xl border p-4 shadow-sm">
        <label class="block text-sm font-semibold mb-1">ç½²åï¼ˆæ¥è‡ªè°ï¼‰</label>
        <input id="fromInput" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400" placeholder="å¦‚ï¼šæ²ˆä¹" value="ä¿¡æ¯å­¦é™¢å›¢å§” å­¦ç”Ÿä¼š" />
      </div>

      <div id="toneBlock" class="glass rounded-2xl border p-4 shadow-sm">
        <label class="block text-sm font-semibold mb-2">ç¥ç¦é£æ ¼</label>
        <select id="toneSelect" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400">
          <option value="warm">æ¸©æƒ…</option>
          <option value="playful">ä¿çš®</option>
          <option value="classic">å¤é£</option>
          <option value="short">ç®€çŸ­</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button id="genBtn" class="flex-1 rounded-xl bg-emerald-500 text-white px-4 py-2 font-medium shadow hover:bg-emerald-600">ç”Ÿæˆç¥ç¦</button>
        <button id="shuffleBtn" class="flex-1 rounded-xl border px-4 py-2 font-medium shadow-sm hover:shadow">æ¢ä¸€å¥</button>
      </div>

      <div class="flex gap-2">
        <button id="copyBtn" class="flex-1 rounded-xl border px-4 py-2 font-medium shadow-sm hover:shadow">å¤åˆ¶ç¥ç¦æ–‡å­—</button>
        <button id="downloadBtn" class="flex-1 rounded-xl bg-teal-600 text-white px-4 py-2 font-medium shadow hover:bg-teal-700">ä¸‹è½½ PNG æµ·æŠ¥</button>
      </div>

      <div id="linkBuilder" class="glass rounded-2xl border p-4 shadow-sm">
        <div class="font-semibold mb-1">ç”Ÿæˆç»™è€å¸ˆçš„ä¸“å±é“¾æ¥</div>
        <ol class="list-decimal text-sm text-zinc-600 pl-4 space-y-1">
          <li>å¡«å¥½ <span class="font-medium">ç½²å</span> ä¸ <span class="font-medium">é£æ ¼</span>ã€‚</li>
          <li>ç‚¹å‡»æŒ‰é’®å¤åˆ¶é“¾æ¥ï¼ˆè€å¸ˆæ‰“å¼€å…ˆçœ‹åˆ°ä¿¡å°å°é¢ï¼Œåªéœ€è¾“å…¥å§“åï¼‰ã€‚</li>
        </ol>
        <div class="mt-3 flex flex-wrap gap-3 items-center">
          <button id="makeLinkBtn" class="rounded-xl border px-4 py-2 text-sm shadow-sm hover:shadow">å¤åˆ¶ä¸“å±é“¾æ¥</button>
          <label class="text-xs flex items-center gap-2"><input id="lockSwitch" type="checkbox" class="rounded" checked> é”å®šç½²å/é£æ ¼</label>
          <label class="text-xs flex items-center gap-2"><input id="teacherViewSwitch" type="checkbox" class="rounded" checked> è€å¸ˆä»…çœ‹ä¿¡å°/è´ºå¡</label>
        </div>
        <p class="mt-2 text-xs text-zinc-500 break-all" id="linkOut"></p>
      </div>
    </section>

    <!-- å³ï¼šé¢„è§ˆåŒº / è€å¸ˆæ¨¡å¼ä¸‹å…¨å®½å±•ç¤º -->
    <section id="previewWrap" class="md:col-span-2">
      <div class="relative">
        <div class="pointer-events-none absolute -inset-6 -z-10 blur-2xl opacity-70">
          <div id="bgGrad" class="h-full w-full rounded-[2rem] bg-gradient-to-br from-rose-200 via-amber-200 to-emerald-200"></div>
        </div>

        <!-- ä¿¡å°å°é¢ï¼ˆè€å¸ˆé¦–æ¬¡è¿›å…¥æ˜¾ç¤ºï¼‰ -->
        <div id="envelopeWrap" class="py-10 md:py-20 flex items-center justify-center">
          <div class="env-3d">
            <div id="envelope" class="envelope">
              <div class="flap"></div>
              <div class="stamp">è‡´æ•¬æå›</div>
              <div class="postmark">TEACHERS' DAY</div>
              <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 p-6">
                <div class="text-zinc-700 text-base md:text-lg">è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–ç§°å‘¼</div>
                <div class="glass rounded-full border shadow px-3 py-1.5 flex items-center gap-2">
                  <input id="teacherOverlayInput" class="w-44 md:w-72 bg-transparent outline-none text-base md:text-lg" placeholder="å¦‚ï¼šç‹è€å¸ˆ" />
                  <button id="overlayApply" class="rounded-full bg-emerald-500 text-white px-4 py-1.5 text-sm md:text-base">å¼€å¯ç¥ç¦</button>
                </div>
                <div class="text-xs text-zinc-500">è¾“å…¥åå°†ä¸ºæ‚¨æ‰“å¼€ä¸“å±è´ºå¡</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è´ºå¡ä¸»ä½“ï¼ˆè€å¸ˆè¾“å…¥åæ˜¾ç¤ºï¼‰ -->
        <div id="cardWrap" class="hidden">
          <div id="card" class="overflow-hidden rounded-[2rem] border bg-white shadow-xl mx-auto" style="width: 960px; max-width: 100%">
            <div class="relative">
              <div class="h-24 w-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400"></div>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-white/95 drop-shadow text-3xl md:text-4xl font-extrabold tracking-wider">æ•™å¸ˆèŠ‚å¿«ä¹</span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5">
              <div class="md:col-span-2 p-8 flex items-center justify-center">
                <svg viewBox="0 0 300 300" class="w-56 h-56 md:w-72 md:h-72 opacity-90">
                  <rect x="40" y="40" width="220" height="160" rx="12" fill="#1f2937" />
                  <rect x="35" y="200" width="230" height="16" rx="4" fill="#d4b08c" />
                  <g stroke="#fff" stroke-width="2" stroke-linecap="round">
                    <path d="M70 90c20-10 40 10 60 0 20-10 40 10 60 0" opacity=".8" />
                    <path d="M70 115h140" opacity=".6" />
                    <path d="M70 140h120" opacity=".5" />
                    <path d="M70 165h90" opacity=".4" />
                    <circle cx="210" cy="165" r="10" fill="none" opacity=".7" />
                  </g>
                  <circle cx="120" cy="230" r="12" fill="#ef4444" />
                  <rect x="118" y="212" width="4" height="6" rx="1" fill="#16a34a" />
                </svg>
              </div>

              <div class="md:col-span-3 p-6 md:p-8">
                <h2 class="text-lg md:text-2xl font-bold tracking-tight"><span id="teacherLabel">äº²çˆ±çš„è€å¸ˆ</span>ï¼š</h2>
                <p id="message" class="text-zinc-700 leading-relaxed text-base md:text-lg whitespace-pre-wrap mt-3"></p>
                <div class="mt-3 text-sm text-zinc-500">â€” æ¥è‡ª <span id="fromLabel" class="font-semibold text-zinc-700"></span></div>
                <div id="chips" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-zinc-500"></div>
              </div>
            </div>

            <div class="p-4 md:p-6 flex items-center justify-between text-xs text-zinc-500 border-t bg-zinc-50/60">
              <span id="cardFoot">ç¥ç¦å¡ â€¢ è‡ªåŠ¨ç”Ÿæˆ</span>
              <span>Made with â¤ï¸</span>
            </div>
          </div>

          <!-- çº¯æ–‡æœ¬é¢„è§ˆï¼ˆç¼–è¾‘æ¨¡å¼å¯è§ï¼‰ -->
          <div id="textPanel" class="mt-4 glass rounded-2xl border p-4">
            <div class="text-sm font-semibold mb-2">ç¥ç¦æ–‡å­—ï¼ˆå¯ç›´æ¥å¤åˆ¶å‘é€ï¼‰</div>
            <pre id="textOut" class="whitespace-pre-wrap text-sm text-zinc-700"></pre>
          </div>

          <!-- ç§»åŠ¨ç«¯æ“ä½œæ¡ï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
          <div id="teacherActionBar" class="action-bar hidden mt-4">
            <div class="mx-auto max-w-2xl glass rounded-2xl border p-2 flex gap-2">
              <button id="copyBtnM" class="flex-1 rounded-xl border px-4 py-2 text-sm font-medium shadow-sm">å¤åˆ¶ç¥ç¦</button>
              <button id="downloadBtnM" class="flex-1 rounded-xl bg-teal-600 text-white px-4 py-2 text-sm font-medium shadow">ä¸‹è½½æµ·æŠ¥</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="rounded-full bg-black/80 text-white text-sm px-4 py-2 shadow">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
  </div>

  <script>
    // â€”â€” å¼€å…³ï¼šæ˜¯å¦ä¸ºè€å¸ˆç«¯ï¼ˆä»…çœ‹ä¿¡å°/è´ºå¡ï¼Œæ— å¤åˆ¶ä¸‹è½½ï¼‰â€”â€”
    const IS_TEACHER = new URLSearchParams(location.search).get('mode') === 'teacher';

    // â€”â€”â€” æ¨¡æ¿ â€”â€”â€”
    const templates = {
      warm: [
        "{T}ï¼Œæ„¿æ¯ä¸€æŸç²‰ç¬”ç°ï¼Œéƒ½å¼€æˆæ‚¨å¿ƒé‡Œçš„å°èŠ±ã€‚{Y}ç¥æ‚¨æ•™å¸ˆèŠ‚å¿«ä¹ï¼",
        "{T}ï¼Œæ‚¨ç”¨è€å¿ƒç‚¹äº®å¥½å¥‡ï¼Œç”¨åšæŒæ‰˜ä½å‹‡æ°”ã€‚{Y}æ„¿æ¯ä¸€å¤©éƒ½è¢«æ¸©æŸ”ä»¥å¾…ã€‚",
        "ä¸‰å°ºè®²å°ï¼Œä¸€ç‰‡èµ¤è¯šã€‚{Y}æƒ³å¯¹{T}è¯´ï¼šæœ‰æ‚¨ï¼ŒçœŸå¥½ï¼æ•™å¸ˆèŠ‚å¿«ä¹ã€‚",
        "{T}ï¼Œç­”æ¡ˆä¼šè¢«å¿˜è®°ï¼Œä½†æ‚¨æ•™æˆ‘çš„æ€è€ƒä¼šä¸€ç›´å‘å…‰ã€‚{Y}ç¥æ‚¨å®‰åº·å–œä¹ï¼",
        "é»‘ç™½ç²‰ç¬”å†™ä¸å°½æ‚¨çš„çƒ­çˆ±ï¼›{Y}æ„¿æ—¶å…‰æ€œæƒœ{T}çš„æ¯ä»½ä»˜å‡ºã€‚",
        "{T}ï¼Œä¸€å£°é—®å€™ã€ä¸€ä¸ªç‚¹å¤´ï¼Œéƒ½æ˜¯ç»™æˆ‘çš„åº•æ°”ã€‚{Y}æ„¿æ‚¨ä¸‡äº‹èƒœæ„ã€‚",
      ],
      playful: [
        "{T}ï¼Œä½œä¸šæˆ‘å¯èƒ½ä¼šé¸½ï¼Œä½†å¯¹æ‚¨çš„æ•¬çˆ±æ°¸ä¸è¿Ÿåˆ°ï¼{Y}æ•™å¸ˆèŠ‚å¿«ä¹~",
        "é€‰æ‹©é¢˜ï¼šè°æœ€ä¼šç‚¹äº®çµæ„Ÿï¼ŸA.{T} B.{T} C.{T}ã€‚æ ‡å‡†ç­”æ¡ˆï¼šå…¨é€‰ï¼{Y}",
        "ä¸Šè¯¾é“ƒæ˜¯BGMï¼Œæ‚¨æ˜¯ä¸»è§’å…‰ç¯ã€‚{Y}ç¥{T}æ¯å¤©å¥½è¿åŒ…å›´~",
        "{T}ï¼ŒçŸ¥è¯†æˆ‘å·²â€œCtrl+Sâ€åœ¨å¿ƒï¼Œå¶å°”ä¹Ÿä¼šâ€œCtrl+Zâ€å¤ä¹ ğŸ˜‰ã€‚{Y}",
        "ç»™{T}é€’ä¸Š100åˆ†çš„å¿«ä¹ä¸å¥½è¿ï¼Œ{Y}ä»»åŠ¡æ‰“å¡ï¼",
      ],
      classic: [
        "æ¡ƒæä¸è¨€ï¼Œä¸‹è‡ªæˆè¹Šã€‚{Y}è°¨ä»¥å¯¸å¿ƒæ•¬çŒ®{T}ï¼Œç¥æ•™å¸ˆèŠ‚å®‰åº·ã€‚",
        "ä¸€æ—¥ä¸ºå¸ˆï¼Œç»ˆèº«ä¸ºèŒƒã€‚{Y}ç¥{T}æ˜¥æ™–éæ³½ï¼ŒèŠ‚æ—¥å‰ç¥¥ã€‚",
        "ç»å¸ˆæ˜“é‡ï¼Œäººå¸ˆéš¾æ±‚ã€‚{Y}æ•¬ç¥{T}å¾·è‰ºé•¿æ˜¥ã€ç¦å®‰åº·å®ã€‚",
        "æ•™ä»¥äººé“ï¼ŒåŒ–ä»¥æ˜¥é£ã€‚{Y}æ„¿{T}é˜–å®¶ç¾æ»¡ï¼ŒèŠ‚åºå®‰å’Œã€‚",
      ],
      short: [
        "{T}ï¼Œæ•™å¸ˆèŠ‚å¿«ä¹ï¼{Y}æ„Ÿæ©æœ‰æ‚¨ã€‚",
        "è°¢è°¢æ‚¨ï¼Œ{T}ã€‚{Y}ç¥èŠ‚æ—¥å¿«ä¹ã€é¡ºå¿ƒå¸¸åœ¨ï¼",
        "å‘{T}è‡´ç¤¼ï¼šæ•™å¸ˆèŠ‚å®‰åº·ã€‚{Y}",
        "æ•¬çˆ±çš„{T}ï¼ŒèŠ‚æ—¥å¿«ä¹ï¼{Y}è¯¸äº‹é¡ºé‚ã€‚",
      ],
    };

    const chipsPool = [
      "ğŸ“š æ„Ÿè°¢æ‚¨çš„è€å¿ƒä¸å®ˆæŠ¤",
      "âœï¸ ä¸‰å°ºè®²å°ï¼Œå†™æ»¡å…‰äº®",
      "ğŸŒŸ æ¡ƒæä¸è¨€ï¼Œä¸‹è‡ªæˆè¹Š",
      "ğŸ€ æ„¿æ‚¨æ—¥æ—¥å¥½è¿ç›¸ä¼´",
      "ğŸ•¯ï¸ ç‚¹ä¸€ç›ç¯ï¼Œç…§äº®æ›´å¤šå­©å­",
      "ğŸ“– è¯»ä¸‡å·ä¹¦ï¼Œä¹Ÿå¿µæ‚¨ä¸€ç¨‹"
    ];

    const suffixPool = [
      "ä»Šå¤©ä¹Ÿè¦å¼€å¼€å¿ƒå¿ƒã€‚",
      "æ„¿ç¬‘å£å¸¸å¼€ï¼Œå¿ƒäº‹éƒ½é¡ºã€‚",
      "æ„¿æ¡ƒæå¸¸å¼€ï¼Œä¸‡äº‹èƒœæ„ã€‚",
      "è®°å¾—å¤šä¼‘æ¯ï¼Œå°‘ç†¬å¤œã€‚",
      "æ„¿æ¯å¤©éƒ½è¢«æ¸©æŸ”ä»¥å¾…ã€‚",
      "èŠ‚æ—¥å¥½å¿ƒæƒ…ï¼Œå…¨å¹´å¥½çŠ¶æ€ã€‚"
    ];

    const gradients = {
      warm: ["from-rose-300 via-amber-200 to-emerald-200","from-rose-200 via-orange-200 to-emerald-100"],
      playful: ["from-indigo-200 via-sky-200 to-pink-200","from-sky-200 via-fuchsia-200 to-pink-200"],
      classic: ["from-stone-100 via-amber-100 to-stone-200","from-zinc-100 via-amber-50 to-stone-200"],
      short: ["from-emerald-100 via-emerald-200 to-teal-200","from-teal-100 via-emerald-100 to-cyan-100"],
    };

    const EMOJI_POOL = ["ğŸŒŸ","ğŸ€","ğŸ§¡","ğŸ“š","ğŸ‰","ğŸŒˆ","âœ¨","ğŸ“"];

    // æŒ‰è€å¸ˆå§“åè‡ªåŠ¨é€‰æ‹©ç¥ç¦é£æ ¼ï¼ˆæ•™å¸ˆç«¯æ— éœ€æ‰‹åŠ¨é€‰æ‹©ï¼‰
    const TONES = ['warm','playful','classic','short'];
    function toneByName(name){ const h = hashCode(name || 'è€å¸ˆ'); return TONES[h % TONES.length]; }

    const $ = (id) => document.getElementById(id);
    const teacherInput = $("teacherInput");
    const fromInput = $("fromInput");
    const toneSelect = $("toneSelect");
    const teacherLabel = $("teacherLabel");
    const fromLabel = $("fromLabel");
    const messageEl = $("message");
    const textOut = $("textOut");
    const bgGrad = $("bgGrad");
    const leftPanel = $("leftPanel");
    const layout = $("layout");
    const header = $("header");
    const textPanel = $("textPanel");

    // Envelope & teacher-only elements
    const envelopeWrap = $("envelopeWrap");
    const envelope = $("envelope");
    const teacherOverlayInput = $("teacherOverlayInput");
    const cardWrap = $("cardWrap");
    const teacherActionBar = $("teacherActionBar");

    let variant = 0;

    function hashCode(str){
      let h = 0; for (let i=0;i<str.length;i++){ h = (h<<5) - h + str.charCodeAt(i); h |= 0; } return Math.abs(h);
    }

    function personalizedVariantByName(name){
      const h = hashCode(name || 'è€å¸ˆ');
      const tone = toneSelect.value || 'warm';
      const list = templates[tone];
      // ä¾æ®åå­—ç”Ÿæˆï¼šå¥å­ç´¢å¼•ã€è¡¨æƒ…ã€è‰²å¸¦ã€chips
      const idx = h % list.length;
      const emoji = EMOJI_POOL[h % EMOJI_POOL.length];
      const gradList = gradients[tone] || gradients.warm;
      const grad = gradList[h % gradList.length];
      const chipsIdx = [h % chipsPool.length, (h>>3) % chipsPool.length, (h>>5) % chipsPool.length];
      return { idx, emoji, grad, chipsIdx:[...new Set(chipsIdx)].slice(0,3), suffix: suffixPool[h % suffixPool.length] };
    }

    function renderMessage() {
      const tone = toneSelect.value || 'warm';
      const list = templates[tone];
      const Traw = (teacherInput.value || 'è€å¸ˆ').replace(/\s+/g,'');
      const from = (fromInput.value || 'æˆ‘').replace(/\s+/g,'');
      const pv = personalizedVariantByName(Traw);
      const raw = list[pv.idx];
      const T = Traw;
      const Y = `${pv.emoji}${from}${pv.emoji}`;
      const msg = raw.replaceAll('{T}', T).replaceAll('{Y}', Y) + ' ' + pv.suffix;

      teacherLabel.textContent = T.includes('è€å¸ˆ') ? T : T + 'è€å¸ˆ';
      fromLabel.textContent = from;
      messageEl.textContent = msg;

      if (textOut) {
        textOut.textContent = `ã€${teacherLabel.textContent}ã€‘\n${msg}\nâ€” æ¥è‡ª ${from}`;
      }

      // æ¸å˜ä¸å°è´´ç‰‡
      bgGrad.className = `h-full w-full rounded-[2rem] bg-gradient-to-br ${pv.grad}`;
      const chips = document.getElementById('chips');
      chips.innerHTML = '';
      pv.chipsIdx.forEach(i=>{
        const d = document.createElement('div');
        d.className = 'rounded-lg border p-2';
        d.textContent = chipsPool[i];
        chips.appendChild(d);
      });
    }

    function copy(text){
      if (!navigator.clipboard) { showToast('è¯·æ‰‹åŠ¨å¤åˆ¶'); return Promise.resolve(); }
      return navigator.clipboard.writeText(text).then(()=>showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
    }

    function toPNG(){
      const node = document.getElementById('card');
      return htmlToImage.toPng(node, { pixelRatio: 2, cacheBust: true, backgroundColor: 'white' });
    }

    function showToast(msg){
      const toast = document.getElementById('toast');
      toast.firstElementChild.textContent = msg || 'å·²å®Œæˆ';
      toast.classList.remove('hidden');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.add('hidden'), 1500);
    }

    function buildShareLink(lock=true, teacherOnly=true){
      const url = new URL(window.location.href);
      url.searchParams.set('tone', toneSelect.value || 'warm');
      if (fromInput.value) url.searchParams.set('from', fromInput.value); else url.searchParams.delete('from');
      url.searchParams.delete('n');
      if (lock) url.searchParams.set('lock','1'); else url.searchParams.delete('lock');
      if (teacherOnly) url.searchParams.set('mode','teacher'); else url.searchParams.delete('mode');
      return url.toString();
    }

    function setLayoutForMode(isTeacher){
      // è€å¸ˆæ¨¡å¼ï¼šéšè—å·¦ä¾§ä¸æ ‡é¢˜ï¼Œä»…æ˜¾ç¤ºä¿¡å°/è´ºå¡ï¼›æ— å¤åˆ¶/ä¸‹è½½/çº¯æ–‡æœ¬
      leftPanel.classList.toggle('hidden', isTeacher);
      header.classList.toggle('hidden', isTeacher);
      if (isTeacher){
        layout.className = 'mx-auto container-max px-4 md:px-8 pb-24 grid grid-cols-1 gap-6';
        const cardFoot = document.getElementById('cardFoot');
        if (cardFoot) cardFoot.textContent = 'ç¥ç¦å¡ â€¢ è‡ªåŠ¨ç”Ÿæˆ';
        if (textPanel) textPanel.classList.add('hidden');
        if (teacherActionBar) teacherActionBar.classList.add('hidden');
      } else {
        layout.className = 'mx-auto container-max px-4 md:px-8 pb-24 grid grid-cols-1 md:grid-cols-3 gap-6';
        if (textPanel) textPanel.classList.remove('hidden');
      }
    }

    function applyURLParams(){
      const p = new URLSearchParams(location.search);
      const n = p.get('n');
      const from = p.get('from');
      const tone = p.get('tone');
      const lock = p.has('lock');
      const mode = p.get('mode');

      if (from) fromInput.value = decodeURIComponent(from); else if (!fromInput.value) fromInput.value = "ä¿¡æ¯å­¦é™¢å›¢å§” å­¦ç”Ÿä¼š";
      if (mode !== 'teacher' && tone && ['warm','playful','classic','short'].includes(tone)) toneSelect.value = tone;
      if (n) teacherInput.value = decodeURIComponent(n);

      setLayoutForMode(mode === 'teacher');

      // é”å®šï¼šè€å¸ˆä¾§ä¸æ˜¾ç¤ºé…ç½®ï¼›å¹¶é»˜è®¤åªæ˜¾ç¤ºä¿¡å°
      if (lock) {
        document.getElementById('fromBlock').classList.add('hidden');
        document.getElementById('toneBlock').classList.add('hidden');
        document.getElementById('linkBuilder').classList.add('hidden');
      }

      // teacher æ¨¡å¼ï¼šåˆå§‹æ˜¾ç¤ºä¿¡å°ï¼›å¡«å†™åæ‰å±•ç¤ºè´ºå¡
      const isTeacher = mode === 'teacher';
      if (isTeacher) {
        envelopeWrap.classList.remove('hidden');
        cardWrap.classList.add('hidden');
        if (teacherActionBar) teacherActionBar.classList.add('hidden');
        teacherOverlayInput && teacherOverlayInput.focus && teacherOverlayInput.focus();
      } else {
        envelopeWrap.classList.add('hidden');
        cardWrap.classList.remove('hidden');
        renderMessage();
      }
    }

    // â€”â€”â€” äº‹ä»¶ç»‘å®š â€”â€”â€”
    document.getElementById('genBtn')?.addEventListener('click', renderMessage);
    // æ•™å¸ˆç«¯ï¼šå›è½¦å³å¼€å¯ç¥ç¦
    teacherOverlayInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('overlayApply')?.click(); }});
    document.getElementById('shuffleBtn')?.addEventListener('click', ()=>{ variant++; renderMessage(); });

    if (!IS_TEACHER) {
      document.getElementById('copyBtn')?.addEventListener('click', ()=> copy(textOut.textContent));
      document.getElementById('downloadBtn')?.addEventListener('click', ()=>{
        toPNG().then(url=>{
          const a = document.createElement('a');
          const n = (teacherInput.value || 'ä¸“å±ç¥ç¦').replace(/\s/g,'');
          a.download = `æ•™å¸ˆèŠ‚ç¥ç¦_${n}.png`;
          a.href = url; a.click();
        }).catch(()=> showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ›´æ¢æµè§ˆå™¨é‡è¯•'))
      });

      document.getElementById('copyBtnM')?.addEventListener('click', ()=> copy(textOut.textContent));
      document.getElementById('downloadBtnM')?.addEventListener('click', ()=>{
        toPNG().then(url=>{ const a = document.createElement('a'); a.download = 'æ•™å¸ˆèŠ‚ç¥ç¦.png'; a.href = url; a.click(); })
        .catch(()=> showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ›´æ¢æµè§ˆå™¨é‡è¯•'))
      });
    }

    // è€å¸ˆè¾“å…¥ â†’ æ‰“å¼€ä¿¡å° â†’ æ˜¾ç¤ºè´ºå¡ï¼ˆæ•™å¸ˆç«¯ä¸æ˜¾ç¤ºä»»ä½•å¤åˆ¶/ä¸‹è½½ï¼‰
    document.getElementById('overlayApply')?.addEventListener('click', ()=>{
      const name = (teacherOverlayInput.value || '').trim();
      if (!name) { showToast('è¯·å…ˆè¾“å…¥ç§°å‘¼'); return; }
      teacherInput.value = name;
      // æ•™å¸ˆç«¯ï¼šæ ¹æ®å§“åè‡ªåŠ¨é€‰æ‹©ç¥ç¦é£æ ¼
      toneSelect.value = toneByName(name);
      envelope.classList.add('open');
      setTimeout(()=>{
        envelopeWrap.classList.add('hidden');
        cardWrap.classList.remove('hidden');
        if (!IS_TEACHER && teacherActionBar) teacherActionBar.classList.remove('hidden');
        renderMessage();
      }, 600);
    });

    // ç”Ÿæˆåˆ†äº«é“¾æ¥ï¼ˆå¸¦è€å¸ˆæ¨¡å¼ + é”å®šï¼‰
    document.getElementById('makeLinkBtn')?.addEventListener('click', ()=>{
      const lock = document.getElementById('lockSwitch').checked;
      const teacherOnly = document.getElementById('teacherViewSwitch').checked;
      const link = buildShareLink(lock, teacherOnly);
      document.getElementById('linkOut').textContent = link;
      if (navigator.clipboard) navigator.clipboard.writeText(link).then(()=>showToast('å·²å¤åˆ¶é“¾æ¥'));
      if (navigator.share) navigator.share({ title: 'æ•™å¸ˆèŠ‚ç¥ç¦', text: 'ç‚¹å¼€è¾“å…¥åå­—é¢†å–ä¸“å±è´ºå¡', url: link }).catch(()=>{});
    });

    // åˆå§‹åŒ–
    applyURLParams();
  </script>
</body>
</html>
